(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/buy/buy"],{223:function(e,t,n){"use strict";(function(e,t){var i=n(4);n(26);i(n(25));var o=i(n(224));e.__webpack_require_UNI_MP_PLUGIN__=n,t(o.default)}).call(this,n(1)["default"],n(2)["createPage"])},224:function(e,t,n){"use strict";n.r(t);var i=n(225),o=n(227);for(var r in o)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(r);n(232);var a,c=n(34),s=Object(c["default"])(o["default"],i["render"],i["staticRenderFns"],!1,null,null,null,!1,i["components"],a);s.options.__file="pages/buy/buy.vue",t["default"]=s.exports},225:function(e,t,n){"use strict";n.r(t);var i=n(226);n.d(t,"render",(function(){return i["render"]})),n.d(t,"staticRenderFns",(function(){return i["staticRenderFns"]})),n.d(t,"recyclableRender",(function(){return i["recyclableRender"]})),n.d(t,"components",(function(){return i["components"]}))},226:function(e,t,n){"use strict";var i;n.r(t),n.d(t,"render",(function(){return o})),n.d(t,"staticRenderFns",(function(){return a})),n.d(t,"recyclableRender",(function(){return r})),n.d(t,"components",(function(){return i}));var o=function(){var e=this,t=e.$createElement,n=(e._self._c,e.__map(e.certificationInfo,(function(t,n){var i=e.__get_orig(t),o=e.indexToNumber(n),r=e.indexToNumber(n);return{$orig:i,m0:o,m1:r}}))),i=e.imageUrl(e.isNeedTicket);e.$mp.data=Object.assign({},{$root:{l0:n,m2:i}})},r=!1,a=[];o._withStripped=!0},227:function(e,t,n){"use strict";n.r(t);var i=n(228),o=n.n(i);for(var r in i)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(r);t["default"]=o.a},228:function(e,t,n){"use strict";(function(e){var i=n(4);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=i(n(53)),r=i(n(55)),a=i(n(5)),c=i(n(30)),s=i(n(31)),u=i(n(56)),d=(i(n(229)),{components:{},data:function(){return{ticketInfo:{guigeArr:[],ticketTime:"",zp:"",ticketType:""},contactInfo:{name:"",phone:""},isValidPhone:!1,isValidArr:[],isValidTax:!1,checkedAddress:{id:0,name:"",is_default:0,mobile:"",full_region:"",address:""},addressId:0,couponId:0,invoices:{type:"",name:"",tax_number:""},isNeedCertification:0,isNeedTicket:!1,openAttr:!1,cartGoods:[],isShowXY:!1,isJieShow:!1}},onLoad:function(t){var n=t.id,i=t.category_id,o=e.getStorageSync("buyItem");this.ticketInfo=JSON.parse(o),this.getIsValidArr(),this.setData({id:n,category_id:i}),console.log(n,i)},onShow:function(){var t=e.getStorageSync("addressId");t&&this.setData({addressId:t});var n=e.getStorageSync("couponId");n&&this.setData({couponId:n}),this.getCheckoutInfo()},computed:{certificationInfo:function(){var e=this.ticketInfo.guigeArr,t=[];return e.forEach((function(e){if(e.chooseCount>0&&e.goods_number>0)for(var n=e.chooseCount;n>0;n--)t.push(e)})),t.map((function(e){return{ticketTime:e.ticketTime,guiGe:e.guiGe,name:"",card:"",cardImgFront:"",cardImgBehind:"",cardImgElectron:""}}))},totalMoney:function(){var e=0;return this.ticketInfo.guigeArr.forEach((function(t){e+=t.retail_price*t.chooseCount})),e}},methods:{indexToNumber:function(e){switch(e+1){case 1:return"①";case 2:return"②";case 3:return"③";case 4:return"④";case 5:return"⑤";case 6:return"⑥";case 7:return"⑦";case 8:return"⑧";case 9:return"⑨";case 10:return"⑩";default:return e}},onCardImgElectron:function(t){var n=this.certificationInfo[t];e.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var i=t.tempFilePaths;n.cardImgElectron=i,e.showLoading({title:"正在上传...",mask:!0});var o="";c.default.request("http://81.70.16.7:8360/api/user/uptoken").then((function(n){o=n.uptoken;var i=t.tempFilePaths[0],r=(new Date).getTime();e.uploadFile({url:"https://up-z2.qiniup.com",filePath:i,name:"file",method:"POST",formData:{key:r,token:o},success:function(t){var n=JSON.parse(t.data),i="http://rnwwnc95c.hn-bkt.clouddn.com/"+n.key;console.log(i),e.hideLoading()},fail:function(t){e.showToast({title:"网络错误",icon:"none"}),console.log(t),e.hideLoading()}})}))}})},previewCardImgElectron:function(t){var n=this.certificationInfo[t];e.previewImage({current:1,urls:n.cardImgElectron,success:function(e){console.log(e)},fail:function(e){console.log(e)}})},previewCardImgFront:function(t){var n=this.certificationInfo[t];e.previewImage({current:1,urls:n.cardImgFront,success:function(e){console.log(e)},fail:function(e){console.log(e)}})},onCardImgFront:function(t){var n=this.certificationInfo[t];e.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var i=t.tempFilePaths;n.cardImgFront=i,e.showLoading({title:"正在上传...",mask:!0});var o="";c.default.request(s.default.uploadImg).then((function(n){o=n.uptoken;var i=t.tempFilePaths[0],r=(new Date).getTime();e.uploadFile({url:s.default.qiniuyunUrl,filePath:i,name:"file",method:"POST",formData:{key:r,token:o},success:function(t){var n=JSON.parse(t.data),i=s.default.qiniuyunBackUrl+n.key;console.log(i),e.hideLoading()},fail:function(t){e.showToast({title:"网络错误",icon:"none"}),console.log(t),e.hideLoading()}})}))}})},previewCardImgBehind:function(t){var n=this.certificationInfo[t];e.previewImage({urls:n.CardImgBehind})},onCardImgBehind:function(t){var n=this.certificationInfo[t];e.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var i=t.tempFilePaths;n.cardImgBehind=i,e.showLoading({title:"正在上传...",mask:!0});var o="";c.default.request(s.default.uploadImg).then((function(i){o=i.uptoken;var r=t.tempFilePaths[0],a=(new Date).getTime();e.uploadFile({url:s.default.qiniuyunUrl,filePath:r,name:"file",method:"POST",formData:{key:a,token:o},success:function(t){var i=JSON.parse(t.data),o=s.default.qiniuyunBackUrl+i.key;console.log(o),console.log(n.cardImgBehind),e.hideLoading()},fail:function(t){e.showToast({title:"网络错误",icon:"none"}),console.log(t),e.hideLoading()}})}))}})},onTypeInvoices:function(e){var t=e.detail.value;this.invoices.type=t},onNameInvoices:function(e){var t=e.detail.value;this.invoices.name=t},onTaxInvoices:function(e){var t=e.detail.value;this.invoices.tax_number=t},validTax_Invoices:function(){var e=this.invoices.tax_number;this.isValidTax=!c.default.checkTax(e)},getCheckoutInfo:function(){var t=this;console.log(t.addressId,t.couponId),c.default.request(s.default.CartCheckout,{addressId:t.addressId,couponId:t.couponId}).then((function(n){0===n.errno&&(console.log(n.data),t.setData({checkedAddress:n.data.checkedAddress})),e.hideLoading()}))},selectAddress:function(){e.navigateTo({url:"/pages/shopping/address/address"})},addAddress:function(){e.navigateTo({url:"/pages/shopping/addressAdd/addressAdd"})},getIsValidArr:function(){this.isValidArr=this.certificationInfo.map((function(e){return!1}))},validCard:function(e){var t=this.certificationInfo[e].card,n=/^[1-9][0-9]{5}(19|20)[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))[0-9]{3}([0-9]|x|X)$/;n.test(t)||this.$set(this.isValidArr,e,!0),n.test(t)&&this.$set(this.isValidArr,e,!1)},validPhone:function(){var e=this.contactInfo.phone;this.isValidPhone=!/^1[3|4|5|6|7|8|9][0-9]\d{8}$/.test(e)},onName:function(e){var t=e.detail.value;this.contactInfo.name=t},onPhone:function(e){var t=e.detail.value;this.contactInfo.phone=t},onCertiName:function(e){var t=e.detail.value,n=e.currentTarget.dataset.i;this.certificationInfo[n].name=t},onCertiCard:function(e){var t=e.detail.value,n=e.currentTarget.dataset.i;this.certificationInfo[n].card=t},onAdress:function(e){var t=e.detail.value;this.adressInfo.adress=t},onJieShow:function(e){var t=(0,a.default)(e.detail.value,1),n=t[0];this.isJieShow="false"==n,console.log(this.isJieShow)},needCertification:function(){this.isNeedCertification=!this.isNeedCertification},needTicket:function(){this.isNeedTicket=!this.isNeedTicket},imageUrl:function(e){return e?"/static/images/buy/dui-2.png":"/static/images/buy/dui.png"},showPopup:function(){this.isShowXY=!0},closePopup:function(){this.isShowXY=!1},buy:function(){var t=this;return(0,r.default)(o.default.mark((function n(){var i,r,a;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(e.showLoading(),t.isCheckedAllSpec()){n.next=3;break}return n.abrupt("return");case 3:return n.prev=3,n.next=6,t.productDlete();case 6:return n.next=8,t.goodsClear();case 8:i=t.ticketInfo.guigeArr,r=t.isWeekend(t.ticketInfo.choosetime),i=i.filter((function(e){return e.chooseCount})),a=0;case 12:if(!(a<i.length)){n.next=18;break}return n.next=15,t.addToCart(i[a],a,r);case 15:a++,n.next=12;break;case 18:t.submitOrder(),n.next=24;break;case 21:n.prev=21,n.t0=n["catch"](3),c.default.showErrorToast(n.t0.errMsg);case 24:case"end":return n.stop()}}),n,null,[[3,21]])})))()},isWeekend:function(e){var t=new Date(e).getDay();return 6===t||0===t},isCheckedAllSpec:function(){var t=this.isValidPhone,n=this.isValidArr,i=this.certificationInfo.map((function(e){return e.card})),o=this.certificationInfo.map((function(e){return e.cardImgFront})),r=this.certificationInfo.map((function(e){return e.cardImgBehind})),a=this.certificationInfo.map((function(e){return e.cardImgElectron})),c=this.contactInfo.phone,s=this.isJieShow,u=this.ticketInfo;return 1==t||-1!=n.indexOf(!0)||i.filter((function(e){return 0==e.length})).length>0||0==c.length||"专业日"==u.zp&&(o.filter((function(e){return 0==e.length})).length>0||r.filter((function(e){return 0==e.length})).length>0||a.filter((function(e){return 0==e.length})).length>0)?(e.showToast({image:"/static/static/images/icon_error.png",title:"请填写完整",mask:!0}),!1):(console.log(s),0!=s||(e.showToast({image:"/static/static/images/icon_error.png",title:"请勾选协议",mask:!0}),!1))},addToCart:function(t,n,i){var a=this;return(0,r.default)(o.default.mark((function r(){return o.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return a.certificationInfo[n]["choosetime"]=a.ticketInfo.choosetime,console.log(a.certificationInfo[n]),o.next=4,c.default.request(s.default.CartAdd,{goodsId:a.id,number:t.chooseCount,productId:t.id,category_id:a.category_id,certification:JSON.stringify([a.certificationInfo[n]]),isWeekend:i},"POST").then((function(t){var n=t;0==n.errno||e.showToast({image:"/static/static/images/icon_error.png",title:n.errmsg,mask:!0})}));case 4:case"end":return o.stop()}}),r)})))()},goodsClear:function(){return(0,r.default)(o.default.mark((function e(){return o.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,c.default.request(s.default.goodsClear,{},"GET");case 2:case"end":return e.stop()}}),e)})))()},productDlete:function(){var e=this;return(0,r.default)(o.default.mark((function t(){return o.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,c.default.request(s.default.productDlete,{goods_id:e.id},"POST");case 2:case"end":return t.stop()}}),t)})))()},submitOrder:function(){c.default.request(s.default.OrderSubmit,{addressId:this.addressId,couponId:this.couponId,category_id:this.category_id,isNoNeedAddress:"电子票"==this.ticketInfo.ticketType,name:this.contactInfo.name,phone:this.contactInfo.phone,isNeedTicket:this.isNeedTicket,invoices:JSON.stringify(this.invoices)},"POST").then((function(t){if(0===t.errno){var n=t.data.orderInfo.id;u.default.payOrder(parseInt(n)).then((function(t){e.redirectTo({url:"/pages/payResult/payResult?status=1&orderId="+n})})).catch((function(t){e.redirectTo({url:"/pages/payResult/payResult?status=0&orderId="+n})}))}else c.default.showErrorToast("下单失败")})).catch((function(e){c.default.showErrorToast("下单失败")}))}}});t.default=d}).call(this,n(2)["default"])},232:function(e,t,n){"use strict";n.r(t);var i=n(233),o=n.n(i);for(var r in i)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(r);t["default"]=o.a},233:function(e,t,n){}},[[223,"common/runtime","common/vendor"]]]);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/buy/buy.js.map